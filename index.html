<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora de Remates</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Desactivar zoom y estilos nativos en inputs */
        input { font-size: 16px !important; }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-3 md:p-8 font-sans text-slate-800">

    <div class="max-w-4xl mx-auto space-y-4">
        
        <!-- Header -->
        <header class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-600 rounded-lg shadow-md shadow-blue-200">
                    <i data-lucide="calculator" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-slate-900 leading-tight">Calculadora Remates</h1>
                </div>
            </div>
            <button onclick="hardReset()" class="text-slate-500 hover:text-red-600 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors text-sm flex items-center gap-1 font-medium">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Limpiar
            </button>
        </header>

        <!-- Tabs de Modo -->
        <div class="bg-white p-1 rounded-xl border border-slate-200 flex w-full shadow-sm">
            <button id="btn-mode-bid" onclick="setMode('bid')" class="flex-1 py-3 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 bg-blue-600 text-white shadow-md">
                <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                Modo Puja
            </button>
            <button id="btn-mode-budget" onclick="setMode('budget')" class="flex-1 py-3 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 text-slate-500 hover:bg-slate-50">
                <i data-lucide="wallet" class="w-4 h-4"></i>
                Modo Presupuesto
            </button>
        </div>

        <!-- Panel Principal -->
        <div class="grid md:grid-cols-2 gap-4">
            
            <!-- Inputs -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col gap-4">
                
                <!-- Descripción -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                        Descripción / Item
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                            <i data-lucide="tag" class="w-4 h-4"></i>
                        </span>
                        <input
                            type="text"
                            id="description-input"
                            oninput="updateDescription(this.value)"
                            placeholder="Ej: Auto Rojo / Lote 10"
                            class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium text-slate-700 placeholder-slate-400"
                        />
                    </div>
                </div>

                <div class="w-full h-px bg-slate-100"></div>

                <!-- Input Principal -->
                <div>
                    <label id="main-input-label" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                        Valor Puja (Martillo)
                    </label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-lg">$</span>
                            <input
                                type="tel" 
                                id="main-input"
                                onkeyup="handleMainInput(this)"
                                oninput="handleMainInput(this)"
                                placeholder="0"
                                class="w-full pl-8 pr-4 py-3 bg-slate-50 border-2 border-blue-100 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-bold text-2xl text-slate-800 placeholder-slate-300 transition-colors"
                            />
                        </div>
                        <!-- Botón Sumar Rápido -->
                        <button 
                            id="btn-quick-add"
                            onclick="quickAdd()"
                            class="bg-blue-50 hover:bg-blue-100 text-blue-600 font-bold rounded-xl px-4 flex items-center justify-center transition-colors active:scale-95 border border-blue-200"
                        >
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Configuración Extra -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                            Incremento
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold">+</span>
                            <input
                                type="tel"
                                id="increment-input"
                                value="100.000"
                                oninput="handleIncrementInput(this)"
                                class="w-full pl-7 pr-2 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium"
                            />
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                            Comisión %
                        </label>
                        <div class="relative">
                            <input
                                type="number"
                                id="tax-input"
                                value="19"
                                oninput="handleTaxInput(this.value)"
                                class="w-full pl-3 pr-8 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium text-center"
                            />
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                                <i data-lucide="percent" class="w-3 h-3"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tarjeta de Resultado -->
            <div id="result-card" class="p-6 rounded-2xl shadow-lg text-white flex flex-col justify-between transition-colors duration-300 bg-blue-600 relative min-h-[250px]">
                
                <button 
                    onclick="copyData()"
                    class="absolute top-3 right-3 p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors backdrop-blur-sm z-10"
                >
                    <i id="copy-icon" data-lucide="copy" class="w-5 h-5 text-white"></i>
                </button>

                <div class="space-y-4">
                    <!-- Descripción Dinámica -->
                    <div id="desc-display-container" class="hidden pb-2 border-b border-white/10">
                        <span class="text-white/60 text-[10px] font-bold uppercase tracking-widest">Item / Lote</span>
                        <h3 id="display-description" class="text-xl font-bold text-white truncate leading-tight mt-1"></h3>
                    </div>

                    <!-- Cálculos -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-end">
                            <span class="text-white/80 text-sm font-medium">Valor Martillo</span>
                            <span id="display-hammer" class="font-bold text-xl tracking-tight">$0</span>
                        </div>
                        
                        <div class="flex justify-between items-end">
                            <span class="text-white/80 text-sm font-medium">Comisión (<span id="display-tax-rate">19</span>%)</span>
                            <span id="display-tax" class="font-medium text-lg text-white/90 tracking-tight">+ $0</span>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-white/20">
                        <span class="block text-xs uppercase tracking-wider text-white/60 mb-1 font-bold">
                            Total Final a Pagar
                        </span>
                        <span id="display-total" class="block text-4xl md:text-5xl font-bold tracking-tight leading-none">
                            $0
                        </span>
                    </div>
                    
                    <!-- Enviar WhatsApp -->
                    <div class="pt-2 mt-auto">
                        <div class="flex gap-2">
                            <input 
                                type="tel" 
                                id="whatsapp-input" 
                                value="56958635985" 
                                class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white placeholder-white/40 text-sm outline-none focus:bg-black/30 transition-colors font-mono"
                                placeholder="Número..."
                            />
                            <button 
                                onclick="sendWhatsapp()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center shadow-lg active:scale-95 shrink-0"
                            >
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Proyecciones -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <h2 class="text-sm font-bold text-slate-700 uppercase flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-4 h-4 text-blue-500"></i>
                    Siguientes Pujas
                </h2>
                <div id="budget-alert" class="hidden bg-amber-50 text-amber-700 px-2 py-1 rounded text-xs font-bold border border-amber-200">
                    Tope: <span id="budget-limit-text"></span>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-100 text-slate-500 text-xs uppercase tracking-wider">
                            <th class="p-3 font-bold border-b border-slate-200">#</th>
                            <th class="p-3 font-bold border-b border-slate-200">Martillo</th>
                            <th class="p-3 font-bold border-b border-slate-200 hidden sm:table-cell">Comisión</th>
                            <th class="p-3 font-bold border-b border-slate-200">Total</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 text-sm">
                        <!-- JS genera esto -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- Variables de Estado ---
        let appState = {
            mode: 'bid',
            baseValue: 0,
            increment: 100000,
            taxRate: 19,
            description: ''
        };
        let tableTimeout;

        // --- Funciones de Formato ---
        const formatMoney = (num) => num ? Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") : '';
        const cleanMoney = (str) => {
            if(!str) return 0;
            const clean = str.toString().replace(/[^\d]/g, ''); // Solo números
            return clean ? parseInt(clean, 10) : 0;
        };
        const toCurrency = (num) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', minimumFractionDigits: 0 }).format(num || 0);

        // --- Inicialización ---
        window.onload = function() {
            lucide.createIcons();
            hardReset(); // Empezar limpio
        };

        function hardReset() {
            appState.baseValue = 0;
            appState.description = '';
            document.getElementById('main-input').value = '';
            document.getElementById('description-input').value = '';
            document.getElementById('desc-display-container').classList.add('hidden');
            renderCalculations();
            renderTable();
        }

        // --- Manejo del Input Principal (CRÍTICO) ---
        function handleMainInput(el) {
            // 1. Obtener valor limpio (sin puntos)
            const rawVal = cleanMoney(el.value);
            
            // 2. Calcular valor base según modo
            if (appState.mode === 'bid') {
                appState.baseValue = rawVal;
            } else {
                appState.baseValue = rawVal / (1 + (appState.taxRate / 100));
            }

            // 3. Renderizar Tarjeta INMEDIATAMENTE (Lo más importante)
            renderCalculations();

            // 4. Formatear input (poner puntos) solo si cambió visualmente
            // Esto evita que el cursor salte o se borre mientras escribes
            const formatted = rawVal === 0 ? '' : formatMoney(rawVal);
            if (el.value.replace(/[^\d]/g, '') !== rawVal.toString()) {
                 // Si el valor numérico cambió drásticamente, forzamos update
                 el.value = formatted;
            } else if (el.value !== formatted && rawVal !== 0) {
                 // Solo actualizamos el formato si no es 0
                 // Guardamos posición del cursor para restaurarla
                 const cursor = el.selectionStart; 
                 // Ajuste simple: si agregamos puntos, el cursor se mueve
                 const lenBefore = el.value.length;
                 el.value = formatted;
                 const lenAfter = el.value.length;
                 if (document.activeElement === el) {
                     // Ajuste aproximado del cursor
                     const newPos = cursor + (lenAfter - lenBefore);
                     el.setSelectionRange(newPos, newPos);
                 }
            }

            // 5. Renderizar tabla con delay (para no trabar el celular)
            if (tableTimeout) clearTimeout(tableTimeout);
            tableTimeout = setTimeout(renderTable, 50);
        }

        // --- Renderizado de Cálculos (Tarjeta Azul/Verde) ---
        function renderCalculations() {
            const hammer = appState.baseValue;
            const tax = hammer * (appState.taxRate / 100);
            const total = hammer + tax;

            document.getElementById('display-hammer').textContent = toCurrency(hammer);
            document.getElementById('display-tax-rate').textContent = appState.taxRate;
            document.getElementById('display-tax').textContent = "+ " + toCurrency(tax);
            document.getElementById('display-total').textContent = toCurrency(total);
        }

        // --- Renderizado de Tabla (Optimizado) ---
        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            const hammer = appState.baseValue;
            const inc = appState.increment;
            const taxFactor = 1 + (appState.taxRate / 100);
            const limit = appState.mode === 'budget' ? (hammer * taxFactor) : 0; // Aproximado para modo budget
            
            // Si estamos en budget mode, el input es el budget total
            const totalBudgetInput = appState.mode === 'budget' ? (hammer * taxFactor) : 0;

            const fragment = document.createDocumentFragment();
            let currentBase = hammer;

            for(let i=1; i<=20; i++) {
                currentBase += inc;
                const total = currentBase * taxFactor;
                const isOver = appState.mode === 'budget' && total > totalBudgetInput;
                
                const tr = document.createElement('tr');
                tr.className = isOver ? 'bg-red-50 text-red-800' : 'hover:bg-blue-50 transition-colors cursor-pointer';
                
                // Closure para el click
                (function(val) {
                    tr.onclick = function() { 
                        appState.baseValue = val;
                        // Si estamos en budget, cambiamos a bid para ver el nuevo valor
                        if(appState.mode === 'budget') {
                            setMode('bid'); 
                        } else {
                            document.getElementById('main-input').value = formatMoney(val);
                            handleMainInput(document.getElementById('main-input'));
                        }
                        window.scrollTo({top:0, behavior:'smooth'});
                    };
                })(currentBase);

                tr.innerHTML = `
                    <td class="p-3 font-medium">+${i}</td>
                    <td class="p-3 font-bold">${formatMoney(currentBase)}</td>
                    <td class="p-3 hidden sm:table-cell text-sm opacity-70">${formatMoney(currentBase * (appState.taxRate/100))}</td>
                    <td class="p-3 font-bold">${formatMoney(total)}</td>
                `;
                fragment.appendChild(tr);
            }
            tbody.appendChild(fragment);

            // Alerta Budget
            const alert = document.getElementById('budget-alert');
            if(appState.mode === 'budget' && totalBudgetInput > 0) {
                alert.classList.remove('hidden');
                document.getElementById('budget-limit-text').textContent = toCurrency(totalBudgetInput);
            } else {
                alert.classList.add('hidden');
            }
        }

        // --- Otras Funciones ---
        function updateDescription(val) {
            appState.description = val;
            const container = document.getElementById('desc-display-container');
            if(val) {
                container.classList.remove('hidden');
                document.getElementById('display-description').textContent = val;
            } else {
                container.classList.add('hidden');
            }
        }

        function handleIncrementInput(el) {
            const val = cleanMoney(el.value);
            appState.increment = val;
            el.value = formatMoney(val);
            if(tableTimeout) clearTimeout(tableTimeout);
            tableTimeout = setTimeout(renderTable, 50);
        }

        function handleTaxInput(val) {
            appState.taxRate = val ? parseFloat(val) : 0;
            renderCalculations();
            renderTable();
        }

        function setMode(mode) {
            appState.mode = mode;
            const isBid = mode === 'bid';
            const btnBid = document.getElementById('btn-mode-bid');
            const btnBudget = document.getElementById('btn-mode-budget');
            const card = document.getElementById('result-card');
            const input = document.getElementById('main-input');
            const label = document.getElementById('main-input-label');
            const quickBtn = document.getElementById('btn-quick-add');

            // Recalcular valor mostrado
            const currentTotal = appState.baseValue * (1 + (appState.taxRate/100));
            // Si pasamos a budget, mostramos el total. Si pasamos a bid, mostramos la base.
            const valToShow = isBid ? appState.baseValue : currentTotal;
            input.value = valToShow === 0 ? '' : formatMoney(valToShow);

            // Estilos
            btnBid.className = isBid ? "flex-1 py-3 rounded-lg text-sm font-bold bg-blue-600 text-white shadow-md" : "flex-1 py-3 rounded-lg text-sm font-bold text-slate-500 hover:bg-slate-50";
            btnBudget.className = !isBid ? "flex-1 py-3 rounded-lg text-sm font-bold bg-emerald-600 text-white shadow-md" : "flex-1 py-3 rounded-lg text-sm font-bold text-slate-500 hover:bg-slate-50";
            
            card.className = isBid ? "p-6 rounded-2xl shadow-lg text-white flex flex-col justify-between transition-colors duration-300 bg-blue-600 relative min-h-[250px]" : "p-6 rounded-2xl shadow-lg text-white flex flex-col justify-between transition-colors duration-300 bg-emerald-600 relative min-h-[250px]";
            
            label.textContent = isBid ? "Valor Puja (Martillo)" : "Presupuesto Total (Tope)";
            
            // Actualizar lógica del input principal
            // Importante: al cambiar de modo, simulamos un input para actualizar el estado baseValue correctamente
            handleMainInput(input);
            
            quickBtn.style.display = isBid ? 'block' : 'none';
        }

        function quickAdd() {
            appState.baseValue += appState.increment;
            if(appState.mode === 'budget') setMode('bid');
            else {
                document.getElementById('main-input').value = formatMoney(appState.baseValue);
                renderCalculations();
                renderTable();
            }
        }

        function copyData() {
            const hammer = appState.baseValue;
            const tax = hammer * (appState.taxRate/100);
            const total = hammer + tax;
            const text = `*ITEM: ${appState.description || 'REMATE'}*\nMartillo: ${toCurrency(hammer)}\nComisión: +${toCurrency(tax)}\n*TOTAL: ${toCurrency(total)}*`;
            
            navigator.clipboard.writeText(text);
            const icon = document.getElementById('copy-icon');
            icon.innerHTML = '<polyline points="20 6 9 17 4 12"></polyline>';
            setTimeout(() => { 
                icon.innerHTML = '<rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>'; 
                lucide.createIcons();
            }, 1000);
        }

        function sendWhatsapp() {
            const num = document.getElementById('whatsapp-input').value.replace(/\D/g, '');
            if(!num) return alert('Ingresa un número válido');
            const hammer = appState.baseValue;
            const tax = hammer * (appState.taxRate/100);
            const total = hammer + tax;
            const text = `*ITEM: ${appState.description || 'REMATE'}*\nMartillo: ${toCurrency(hammer)}\nComisión: +${toCurrency(tax)}\n*TOTAL: ${toCurrency(total)}*`;
            window.open(`https://wa.me/${num}?text=${encodeURIComponent(text)}`, '_blank');
        }

    </script>
</body>
</html>


