<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora de Remates</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconos Lucide (CDN más rápido) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Estilos base */
        body { -webkit-tap-highlight-color: transparent; }
        
        /* Inputs numéricos limpios */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        /* Prevenir zoom automático en iOS al escribir */
        input { font-size: 16px !important; }

        .smooth-transition {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-3 md:p-8 font-sans text-slate-800">

    <div class="max-w-4xl mx-auto space-y-5">
        
        <!-- Header -->
        <header class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-600 rounded-lg shadow-md shadow-blue-200">
                    <i data-lucide="calculator" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-slate-900 leading-tight">Calculadora Remates</h1>
                </div>
            </div>
            <button onclick="hardReset()" class="text-slate-500 hover:text-red-600 hover:bg-red-50 px-3 py-2 rounded-lg transition-colors text-sm flex items-center gap-1 font-medium border border-transparent hover:border-red-100">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Limpiar Todo
            </button>
        </header>

        <!-- Tabs de Modo -->
        <div class="bg-white p-1 rounded-xl border border-slate-200 flex w-full shadow-sm">
            <button id="btn-mode-bid" onclick="setMode('bid')" class="flex-1 py-3 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 bg-blue-600 text-white shadow-md">
                <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                Modo Puja
            </button>
            <button id="btn-mode-budget" onclick="setMode('budget')" class="flex-1 py-3 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 text-slate-500 hover:bg-slate-50">
                <i data-lucide="wallet" class="w-4 h-4"></i>
                Modo Presupuesto
            </button>
        </div>

        <!-- Panel Principal -->
        <div class="grid md:grid-cols-2 gap-4">
            
            <!-- Formulario -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-between gap-4">
                
                <!-- Campo Descripción -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                        Descripción / Item
                    </label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                            <i data-lucide="tag" class="w-4 h-4"></i>
                        </span>
                        <input
                            type="text"
                            id="description-input"
                            oninput="updateDescription(this.value)"
                            placeholder="Ej: Auto Rojo / Lote 10"
                            class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium text-slate-700 placeholder-slate-400"
                        />
                    </div>
                </div>

                <div class="w-full h-px bg-slate-100"></div>

                <!-- Input Principal -->
                <div>
                    <label id="main-input-label" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                        Valor Puja (Martillo)
                    </label>
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-lg">$</span>
                            <input
                                type="text"
                                inputmode="numeric"
                                id="main-input"
                                oninput="handleMainInput(this)"
                                onfocus="this.select()"
                                placeholder="0"
                                class="w-full pl-8 pr-4 py-3 bg-slate-50 border-2 border-blue-100 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-bold text-2xl text-slate-800 placeholder-slate-300 transition-colors"
                            />
                        </div>
                        <!-- Botón Sumar Rápido -->
                        <button 
                            id="btn-quick-add"
                            onclick="quickAdd()"
                            class="bg-blue-50 hover:bg-blue-100 text-blue-600 font-bold rounded-xl px-4 flex items-center justify-center transition-colors active:scale-95 border border-blue-200"
                            title="Sumar incremento"
                        >
                            <i data-lucide="plus" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>

                <!-- Configuración Extra -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                            Incremento
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold">+</span>
                            <input
                                type="text"
                                inputmode="numeric"
                                id="increment-input"
                                value="100.000"
                                oninput="handleIncrementInput(this)"
                                onfocus="this.select()"
                                class="w-full pl-7 pr-2 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium"
                            />
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                            Comisión %
                        </label>
                        <div class="relative">
                            <input
                                type="number"
                                id="tax-input"
                                value="19"
                                oninput="handleTaxInput(this.value)"
                                onfocus="this.select()"
                                class="w-full pl-3 pr-8 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium text-center"
                            />
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                                <i data-lucide="percent" class="w-3 h-3"></i>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tarjeta de Resultado -->
            <div id="result-card" class="p-6 rounded-2xl shadow-lg text-white flex flex-col justify-between transition-colors duration-300 bg-blue-600 relative">
                
                <!-- Botón Copiar Flotante -->
                <button 
                    onclick="copyData()"
                    class="absolute top-3 right-3 p-2 bg-white/10 hover:bg-white/20 rounded-lg transition-colors backdrop-blur-sm z-10"
                    title="Copiar datos"
                >
                    <i id="copy-icon" data-lucide="copy" class="w-5 h-5 text-white"></i>
                </button>

                <div class="space-y-4">
                    <!-- Descripción Dinámica -->
                    <div id="desc-display-container" class="hidden pb-3 border-b border-white/10">
                        <span class="text-white/60 text-[10px] font-bold uppercase tracking-widest">Item / Lote</span>
                        <h3 id="display-description" class="text-xl font-bold text-white truncate leading-tight mt-1"></h3>
                    </div>

                    <!-- Cálculos -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-end">
                            <span class="text-white/80 text-sm font-medium">Valor Martillo</span>
                            <span id="display-hammer" class="font-bold text-xl tracking-tight">$0</span>
                        </div>
                        
                        <div class="flex justify-between items-end">
                            <span class="text-white/80 text-sm font-medium">Comisión (<span id="display-tax-rate">19</span>%)</span>
                            <span id="display-tax" class="font-medium text-lg text-white/90 tracking-tight">+ $0</span>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-white/20">
                        <span class="block text-xs uppercase tracking-wider text-white/60 mb-1 font-bold">
                            Total Final a Pagar
                        </span>
                        <span id="display-total" class="block text-4xl md:text-5xl font-bold tracking-tight leading-none">
                            $0
                        </span>
                    </div>
                    
                    <!-- Enviar WhatsApp -->
                    <div class="pt-4 mt-auto">
                        <div class="flex gap-2">
                            <input 
                                type="tel" 
                                id="whatsapp-input" 
                                value="56958635985" 
                                class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white placeholder-white/40 text-sm outline-none focus:bg-black/30 transition-colors font-mono"
                                placeholder="Número..."
                            />
                            <button 
                                onclick="sendWhatsapp()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center shadow-lg active:scale-95 shrink-0"
                            >
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Proyecciones -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                <h2 class="text-sm font-bold text-slate-700 uppercase flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-4 h-4 text-blue-500"></i>
                    Siguientes Pujas
                </h2>
                <div id="budget-alert" class="hidden bg-amber-50 text-amber-700 px-2 py-1 rounded text-xs font-bold border border-amber-200">
                    Tope: <span id="budget-limit-text"></span>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-100 text-slate-500 text-xs uppercase tracking-wider">
                            <th class="p-3 font-bold border-b border-slate-200">#</th>
                            <th class="p-3 font-bold border-b border-slate-200">Martillo</th>
                            <th class="p-3 font-bold border-b border-slate-200 hidden sm:table-cell">Comisión</th>
                            <th class="p-3 font-bold border-b border-slate-200">Total</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100 text-sm">
                        <!-- JS genera esto -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- Variables Globales Limpias ---
        let appState = {
            mode: 'bid',         // 'bid' o 'budget'
            baseValue: 0,        // Valor numérico real
            totalBudget: 0,      // Valor numérico real
            increment: 100000,   // Incremento defecto
            taxRate: 19,         // Porcentaje
            description: ''      // Texto
        };
        
        // Timeout para no bloquear el celular al renderizar la tabla
        let renderTimeout;

        // --- Funciones de Formato Seguras ---
        const formatMoney = (num) => {
            if (!num && num !== 0) return '';
            // Convertir a string con puntos de miles
            return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        const cleanMoney = (str) => {
            if (!str) return 0;
            // Eliminar todo lo que no sea número
            const clean = str.toString().replace(/\./g, '').replace(/[^\d]/g, '');
            return clean === '' ? 0 : parseInt(clean, 10);
        };

        const toCurrency = (num) => {
            return new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP',
                minimumFractionDigits: 0
            }).format(num || 0);
        };

        // --- Lógica Principal ---

        function init() {
            lucide.createIcons();
            // Iniciar limpio
            hardReset();
        }

        function hardReset() {
            // Reiniciar estado a 0
            appState.baseValue = 0;
            appState.totalBudget = 0;
            appState.description = '';
            
            // Limpiar inputs visuales
            document.getElementById('main-input').value = '';
            document.getElementById('description-input').value = '';
            
            // Forzar actualización visual
            handleDescriptionInput('');
            refreshCalculations();
        }

        // Manejo de Descripción (Separado para no trabar cálculos)
        function updateDescription(val) {
            appState.description = val;
            const container = document.getElementById('desc-display-container');
            const text = document.getElementById('display-description');
            
            if (val.trim()) {
                container.classList.remove('hidden');
                text.textContent = val;
            } else {
                container.classList.add('hidden');
            }
        }

        // Manejo Input Principal (Con cuidado del cursor)
        function handleMainInput(el) {
            // 1. Obtener valor limpio
            const rawValue = cleanMoney(el.value);
            
            // 2. Guardar en estado según modo
            if (appState.mode === 'bid') {
                appState.baseValue = rawValue;
                // Calculamos presupuesto derivado
                appState.totalBudget = rawValue * (1 + (appState.taxRate / 100));
            } else {
                appState.totalBudget = rawValue;
                // Calculamos base derivada
                appState.baseValue = rawValue / (1 + (appState.taxRate / 100));
            }

            // 3. Formatear input (poner puntos) sin saltar el cursor
            const oldVal = el.value;
            const formatted = rawValue === 0 ? '' : formatMoney(rawValue); // Si es 0 mostramos vacío
            
            if (oldVal !== formatted) {
                // Truco para mantener cursor al final si escribimos normal
                // Si editamos al medio es más complejo, pero para remates (rapidez) esto basta
                el.value = formatted; 
            }

            // 4. Actualizar resto de la UI
            refreshCalculations();
        }

        function handleIncrementInput(el) {
            const val = cleanMoney(el.value);
            appState.increment = val;
            el.value = val === 0 ? '' : formatMoney(val);
            scheduleTableRender(); // Renderizar tabla diferido
        }

        function handleTaxInput(val) {
            appState.taxRate = val ? parseFloat(val) : 0;
            // Recalcular dependencias
            if (appState.mode === 'bid') {
                appState.totalBudget = appState.baseValue * (1 + (appState.taxRate / 100));
            } else {
                appState.baseValue = appState.totalBudget / (1 + (appState.taxRate / 100));
            }
            refreshCalculations();
        }

        function setMode(mode) {
            appState.mode = mode;
            updateModeStyles();
            
            // Sincronizar input visual
            const valToShow = mode === 'bid' ? appState.baseValue : appState.totalBudget;
            document.getElementById('main-input').value = valToShow === 0 ? '' : formatMoney(valToShow);
            
            refreshCalculations();
        }

        function quickAdd() {
            // Sumar incremento a la base
            const current = appState.baseValue;
            const next = current + appState.increment;
            
            appState.baseValue = next;
            appState.totalBudget = next * (1 + (appState.taxRate / 100));
            
            // Si estábamos en presupuesto, pasamos a puja para ver el nuevo valor
            if (appState.mode === 'budget') {
                setMode('bid');
            } else {
                // Actualizar solo input visual
                document.getElementById('main-input').value = formatMoney(next);
                refreshCalculations();
            }
        }

        // --- Renderizado UI ---

        function refreshCalculations() {
            // 1. Renderizar Tarjeta (Rápido)
            const hammer = appState.baseValue;
            const tax = hammer * (appState.taxRate / 100);
            const total = hammer + tax;

            document.getElementById('display-hammer').textContent = toCurrency(hammer);
            document.getElementById('display-tax-rate').textContent = appState.taxRate;
            document.getElementById('display-tax').textContent = "+ " + toCurrency(tax);
            document.getElementById('display-total').textContent = toCurrency(total);

            // 2. Agendar renderizado de tabla (Lento, no bloquear UI)
            scheduleTableRender();
        }

        function scheduleTableRender() {
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(renderTable, 50); // Esperar 50ms a que termines de escribir
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = ''; // Limpiar

            const hammer = appState.baseValue;
            const taxFactor = appState.taxRate / 100;
            const inc = appState.increment;
   
