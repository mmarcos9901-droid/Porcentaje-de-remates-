<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Remates</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Estilos base para inputs numéricos */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Animaciones suaves */
        .transition-all {
            transition-property: all;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
            transition-duration: 300ms;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-3 md:p-8 font-sans text-slate-800">

    <div class="max-w-4xl mx-auto space-y-5">
        
        <!-- Header -->
        <header class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-blue-600 rounded-lg shadow-md shadow-blue-200">
                    <i data-lucide="calculator" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-slate-900 leading-tight">Calculadora Remates</h1>
                </div>
            </div>
            <button onclick="resetAll()" class="text-slate-400 hover:text-red-500 hover:bg-red-50 px-3 py-2 rounded-lg transition-all text-sm flex items-center gap-1">
                <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Limpiar
            </button>
        </header>

        <!-- Tabs de Modo -->
        <div class="bg-white p-1 rounded-xl border border-slate-200 flex w-full shadow-sm">
            <button id="btn-mode-bid" onclick="setMode('bid')" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2 bg-blue-600 text-white shadow-md">
                <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                Modo Puja
            </button>
            <button id="btn-mode-budget" onclick="setMode('budget')" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2 text-slate-600 hover:bg-slate-50">
                <i data-lucide="wallet" class="w-4 h-4"></i>
                Modo Presupuesto
            </button>
        </div>

        <!-- Panel Principal -->
        <div class="grid md:grid-cols-2 gap-4">
            
            <!-- Inputs -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-between">
                <div class="space-y-5">
                    
                    <!-- Campo Descripción: Optimizado para no bloquear -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                            Descripción / Item (Opcional)
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                                <i data-lucide="tag" class="w-4 h-4"></i>
                            </span>
                            <input
                                type="text"
                                id="description-input"
                                oninput="handleDescriptionInput(this.value)"
                                placeholder="Ej: BMW 1200 / Lote 45"
                                class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium text-slate-700 placeholder-slate-400"
                            />
                        </div>
                    </div>

                    <div class="w-full h-px bg-slate-100"></div>

                    <!-- Input Dinámico (Cambia según modo) -->
                    <div>
                        <label id="main-input-label" class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                            Valor Puja (Martillo)
                        </label>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                                <input
                                    type="text"
                                    inputmode="numeric"
                                    id="main-input"
                                    oninput="handleMainInput(this.value)"
                                    onfocus="this.select()"
                                    placeholder="0"
                                    class="w-full pl-8 pr-4 py-3 bg-slate-50 border-2 border-blue-100 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none font-bold text-2xl text-slate-800 placeholder-slate-300"
                                />
                            </div>
                            <!-- Botón Sumar (Solo visible en modo Puja) -->
                            <button 
                                id="btn-quick-add"
                                onclick="quickAddIncrement()"
                                class="bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold rounded-xl px-4 flex items-center justify-center transition-colors active:scale-95"
                                title="Sumar incremento actual"
                            >
                                <i data-lucide="plus-circle" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div id="quick-add-text" class="text-right mt-1">
                            <span class="text-xs text-blue-500 font-medium cursor-pointer hover:underline" onclick="quickAddIncrement()">
                                + Sumar <span id="increment-display-text">100.000</span>
                            </span>
                        </div>
                    </div>

                    <!-- Inputs Secundarios -->
                    <div class="grid grid-cols-5 gap-3">
                        <div class="col-span-3">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                                Incremento
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-medium">+</span>
                                <input
                                    type="text"
                                    inputmode="numeric"
                                    id="increment-input"
                                    oninput="handleIncrementInput(this.value)"
                                    onfocus="this.select()"
                                    class="w-full pl-7 pr-2 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium"
                                />
                            </div>
                            <!-- Presets -->
                            <div class="flex gap-1 mt-2 overflow-x-auto pb-1">
                                <button onclick="setQuickIncrement(10000)" class="px-2 py-1 bg-slate-100 hover:bg-slate-200 rounded text-xs text-slate-600 whitespace-nowrap">10k</button>
                                <button onclick="setQuickIncrement(50000)" class="px-2 py-1 bg-slate-100 hover:bg-slate-200 rounded text-xs text-slate-600 whitespace-nowrap">50k</button>
                                <button onclick="setQuickIncrement(100000)" class="px-2 py-1 bg-slate-100 hover:bg-slate-200 rounded text-xs text-slate-600 whitespace-nowrap">100k</button>
                            </div>
                        </div>

                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                                Comisión %
                            </label>
                            <div class="relative">
                                <input
                                    type="number"
                                    id="tax-input"
                                    value="19"
                                    oninput="handleTaxInput(this.value)"
                                    onfocus="this.select()"
                                    class="w-full pl-3 pr-8 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-medium text-center"
                                />
                                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                                    <i data-lucide="percent" class="w-3 h-3"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tarjeta de Resultado -->
            <div id="result-card" class="p-6 rounded-2xl shadow-lg text-white flex flex-col justify-between transition-colors duration-300 bg-blue-600 relative">
                <button 
                    onclick="copyToClipboard()"
                    class="absolute top-2 right-2 p-2 hover:bg-white/10 rounded-lg transition-colors group z-10"
                    title="Copiar resumen"
                >
                    <i id="copy-icon" data-lucide="copy" class="w-5 h-5 text-white/70 group-hover:text-white"></i>
                </button>

                <div class="space-y-4">
                    <!-- Descripción -->
                    <div id="card-description-container" class="hidden mb-2 pb-2 border-b border-white/10">
                        <span class="text-white/60 text-xs font-bold uppercase tracking-wider">Item / Lote</span>
                        <h3 id="display-description" class="text-xl font-bold text-white truncate"></h3>
                    </div>

                    <div class="flex justify-between items-end border-b border-white/20 pb-2">
                        <span class="text-white/80 text-sm">Valor Martillo</span>
                        <span id="display-hammer" class="font-bold text-xl">$0</span>
                    </div>
                    
                    <div class="flex justify-between items-end border-b border-white/20 pb-2">
                        <span class="text-white/80 text-sm">Comisión (<span id="display-tax-rate">19</span>%)</span>
                        <span id="display-tax" class="font-medium text-lg text-white/90">+ $0</span>
                    </div>

                    <div class="pt-2">
                        <span class="block text-xs uppercase tracking-wider text-white/60 mb-1">
                            Total Final a Pagar
                        </span>
                        <span id="display-total" class="block text-4xl md:text-5xl font-bold tracking-tight break-words leading-none">
                            $0
                        </span>
                    </div>
                    
                    <!-- SECCIÓN WHATSAPP -->
                    <div class="mt-4 pt-3 border-t border-white/20">
                        <div class="flex items-center gap-2 mb-1">
                            <i data-lucide="message-circle" class="w-4 h-4 text-white/80"></i>
                            <span class="text-xs text-white/80 font-medium uppercase">Enviar a WhatsApp</span>
                        </div>
                        <div class="flex gap-2">
                            <input 
                                type="tel" 
                                id="whatsapp-input" 
                                value="56958635985" 
                                class="flex-1 bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white placeholder-white/40 text-sm outline-none focus:bg-black/30 transition-colors font-mono"
                                placeholder="Ej: 569..."
                            />
                            <button 
                                onclick="sendToWhatsapp()" 
                                class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg transition-colors flex items-center justify-center shadow-lg active:scale-95"
                                title="Enviar mensaje"
                            >
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Tabla de Proyecciones -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-4 bg-slate-50/80 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                <div>
                    <h2 class="text-sm font-bold text-slate-700 uppercase flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-4 h-4 text-blue-500"></i>
                        Siguientes Pujas
                    </h2>
                </div>
                <div id="budget-warning" class="hidden items-center gap-1 text-xs font-medium text-amber-600 bg-amber-50 px-2 py-1 rounded border border-amber-100">
                    <i data-lucide="alert-circle" class="w-3 h-3"></i>
                    Límite visible: <span id="budget-limit-display">$0</span>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-100 text-slate-500 text-xs uppercase tracking-wider">
                            <th class="p-3 font-semibold border-b border-slate-200">#</th>
                            <th class="p-3 font-semibold border-b border-slate-200">Puja (Martillo)</th>
                            <th class="p-3 font-semibold border-b border-slate-200 hidden sm:table-cell">Comisión</th>
                            <th class="p-3 font-semibold border-b border-slate-200">Total Final</th>
                        </tr>
                    </thead>
                    <tbody id="projection-table-body" class="divide-y divide-slate-100 text-sm">
                        <!-- Las filas se generan con JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Lógica de la Aplicación -->
    <script>
        // Estado inicial
        let state = {
            mode: 'bid', // 'bid' o 'budget'
            baseValue: 1000000,
            totalBudget: 1500000,
            increment: 100000,
            taxRate: 19,
            description: ''
        };

        let tableTimeout = null;

        // --- Funciones de Formato Eficientes ---

        // Regex pre-compilada para mayor velocidad
        const numberFormatRegex = /\B(?=(\d{3})+(?!\d))/g;

        function formatNumber(num) {
            if (num === '' || num === null || isNaN(num)) return '';
            // Usamos una conversión más directa
            return Math.round(num).toString().replace(numberFormatRegex, ".");
        }

        function parseFormatted(str) {
            if (!str) return '';
            // Versión simplificada para limpieza
            return str.replace(/[^\d]/g, '');
        }

        const currencyFormatter = new Intl.NumberFormat('es-CL', {
            style: 'currency',
            currency: 'CLP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        });

        function formatCurrency(num) {
            if (num === '' || isNaN(num)) return '$0';
            return currencyFormatter.format(num);
        }

        // --- Lógica del Core ---

        function init() {
            lucide.createIcons();
            // Inicialización completa
            renderCard();
            updateInputs();
            renderTable(); // Renderizado inicial de la tabla
        }

        function setMode(newMode) {
            state.mode = newMode;
            if (state.mode === 'bid') {
                const tax = state.baseValue * (state.taxRate / 100);
                state.totalBudget = state.baseValue + tax;
            } else {
                const newBase = state.totalBudget / (1 + (state.taxRate / 100));
                state.baseValue = newBase;
            }
            
            updateModeUI();
            updateInputs();
            renderCard();
            requestTableUpdate(); // Tabla diferida
        }

        function handleDescriptionInput(val) {
            state.description = val;
            // Solo actualizamos el DOM de la descripción, NO la tabla entera
            const descContainer = document.getElementById('card-description-container');
            const descDisplay = document.getElementById('display-description');
            
            if (state.description && state.description.trim() !== '') {
                descContainer.classList.remove('hidden');
                descDisplay.textContent = state.description;
            } else {
                descContainer.classList.add('hidden');
            }
        }

        function handleMainInput(val) {
            const cleanVal = parseFormatted(val);
            const inputEl = document.getElementById('main-input');
            
            // Actualización de estado
            if (cleanVal === '') {
                if (state.mode === 'bid') state.baseValue = '';
                else state.totalBudget = '';
            } else {
                const numVal = parseFloat(cleanVal);
                if (state.mode === 'bid') {
                    state.baseValue = numVal;
                    state.totalBudget = numVal * (1 + (state.taxRate / 100));
                } else {
                    state.totalBudget = numVal;
                    state.baseValue = numVal / (1 + (state.taxRate / 100));
                }
            }

            // 1. Renderizado Crítico (Inmediato)
            renderCard();
            
            // 2. Mantenimiento del cursor y formato del input
            const oldSelectionStart = inputEl.selectionStart;
            const oldLength = inputEl.value.length;
            const formatted = formatNumber(cleanVal);
            inputEl.value = formatted;
            const newLength = formatted.length;
            
            if (document.activeElement === inputEl) {
                const newPos = oldSelectionStart + (newLength - oldLength);
                inputEl.setSelectionRange(newPos, newPos);
            }

            // 3. Renderizado No Crítico (Diferido/Debounced)
            requestTableUpdate();
        }

        function handleIncrementInput(val) {
            const cleanVal = parseFormatted(val);
            const inputEl = document.getElementById('increment-input');

            if (cleanVal === '') {
                state.increment = '';
            } else {
                state.increment = parseFloat(cleanVal);
            }
            
            // Actualizar visual input
            inputEl.value = formatNumber(cleanVal);
            
            // Actualizar resto UI
            document.getElementById('increment-display-text').textContent = formatNumber(state.increment);
            requestTableUpdate(); // Diferido
        }

        function setQuickIncrement(amount) {
            state.increment = amou
